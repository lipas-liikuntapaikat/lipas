input {
  gelf {
    type => docker
    port => 5000
  }
}

filter {
  # ES 8 expects host as an object, not a string
  # Rename [host] to [host][name] for compatibility
  if [host] {
    mutate {
      rename => { "[host]" => "[host][name]" }
    }
  }

  if [type] == "docker" {

    if [tag] == "mapproxy" {
      grok {
        match => {"message" => ["%{URIPATH:path} => generated %{INT:bytes_sent} bytes in %{INT:duration} msecs \(HTTP/1.1 %{INT:status}\)"]}
      }
    }
    
    if [tag] == "proxy" {
      json {
        source => "message"
      }
      mutate {
        convert => {
          "body_bytes_sent" => "integer"
          "bytes_sent" => "integer"
          "request_length" => "integer"
          "status" => "integer"
          "upstream_connect_time" => "float"
          "upstream_response_time" => "float"
        }
      }
    }
  }
}

output {
  # stdout {}
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    # Use Index Lifecycle Management for automatic log rotation
    ilm_enabled => true
    ilm_rollover_alias => "logstash"
    ilm_pattern => "000001"
    ilm_policy => "logstash-policy"
  }
}
